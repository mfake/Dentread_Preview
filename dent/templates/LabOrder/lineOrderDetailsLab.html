{% extends 'dentread_dashbase.html' %}
{% load static %}
{% block content %}
{% if user.is_authenticated %}

<div class="container position-relative" id="mainContainer" style=" padding: 2rem 3rem 0 3rem;">
    <div class="table-wrapper" style="padding: 1rem; background-color: white; margin-bottom: 1rem;">
        <table class="table" >
            <thead id="tableHead">
                <tr style="color: blue; text-align: center;">
                    <th></th>
                    <th>Status</th>
                    <th style="width: 45%;">Details</th>
                    <th style="width: 15%;">Action</th>
                    <th style="width: 30%;">Comments</th>
                </tr>
            </thead>

            <tbody id="tableBody">
                     
                <tr class="orderSubmittedRow">
                    <td><i class="fa fa-duotone fa-circle timeLineCircle"></i></td>
                    <th>Submit Order</th>
                    <td class="orderDetails"><span style="font-weight: 500;">{{lineItem.name}}</span>  from <span style="font-weight: 500;">{{refer_id}}</span>  submitted a Service Order for <span style="font-weight: 500;">{{lineItem.service_name}}</span> on <span style="font-weight: 500;">{{lineItem.date}}</span> </td>   
                    <td></td>
                    <td></td>
                </tr>
                
                <tr class="dataValidatedRow">
                    <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                    <th>Validate Data</th>
                    <td class="orderDetails">
                        {% if lineItem.status == 'Validate Data' %}
                        <span style="font-weight: 500">{{org.orgname}}</span> has reviewed the shared Data</td>
                        {% endif %}
                        {% if lineItem.status == 'Submit Order' %}
                        <span style="font-weight: 500">{{org.orgname}}</span> is yet to review the shared Data. Please validate the data first.</td>
                        {% endif %}

                    <td></td>
                    <td></td>
                    
                    <!-- <table>
                    </table> -->
                </tr>

                {% if service_order.file %}
                    <tr class="imageDataApproval imageDataApproval1">
                        <td></td>
                        <td>
                            {% if service_order.fileStatus %}
                                {% if service_order.fileStatus == 'Approve'%}
                                    <span class="badge badge-success ml-2">Approved</span>
                                {% endif %}
                                {% if service_order.fileStatus == 'Reject'%}
                                    <span class="badge badge-warning ml-2">Rejected</span>
                                {% endif %}
                                {% if service_order.fileStatus == 'Re-uploaded'%}
                                    <span class="badge badge-info ml-2">Re-Uploaded</span>
                                {% endif %}

                            {% endif %}
                        </td>
                        <td>
                            {{ service_order.file }} <span class="badge badge-primary ml-2">Dicom 1</span>
                        </td>
                        <td class="dataUpload d-flex justify-content-between align-items-center">
                            <a class="{{ service_order.down }}" target="_blank" download href="/orthancdownloadGuide/{{service_order.id}}/First">
                                <i class="fa-solid fa-download"></i>
                            </a>
                            <a class="{{ service_order.down }}" target="_blank" href="http://68.178.166.31:3000/viewer/{{service_order.StudyInstanceUID}}">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                            
                            {% if service_order.fileStatus != 'Approve' %}
                                <i class="fa-solid fa-file-lines" data-toggle="modal" data-target="#statusModal" onclick="onStatusModalClick('{{service_order.file}}', '{{ service_order.id }}', 1)"></i>
                            {% endif %}
                        </td>
                        <td class="dataComment text-center">
                            {% if service_order.fileComment %}
                                {{service_order.fileComment}}
                            {% endif %}
                        </td>   
                    </tr>
                {% endif %}

                {% if service_order.file1 %}
                    <tr class="imageDataApproval imageDataApproval2">
                        <td></td>
                        <td>
                            {% if service_order.fileStatus1 %}
                                {% if service_order.fileStatus1 == 'Approve'%}
                                    <span class="badge badge-success ml-2">Approved</span>
                                {% endif %}
                                {% if service_order.fileStatus1 == 'Reject'%}
                                    <span class="badge badge-warning ml-2">Rejected</span>
                                {% endif %}
                                {% if service_order.fileStatus1 == 'Re-uploaded'%}
                                    <span class="badge badge-info ml-2">Re-Uploaded</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {{ service_order.file1 }} <span class="badge badge-primary ml-2">Dicom 2</span>
                        </td>
                        <td class="dataUpload d-flex justify-content-between align-items-center">

                            <a class="{{service_order.down}}" target="_blank" download href="/orthancdownloadGuide/{{service_order.id}}/Second">
                                <i class="fa-solid fa-download"></i>
                            </a>
                            
                            <a class="{{service_order.down}}" target="_blank" href="http://68.178.166.31:3000/viewer/{{service_order.StudyInstanceUID1}}">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                            {% if service_order.fileStatus1 != 'Approve' %}
                                <i class="fa-solid fa-file-lines" data-toggle="modal" data-target="#statusModal" onclick="onStatusModalClick('{{service_order.file}}', '{{ service_order.id }}', 2)"></i>
                            {% endif %}
                        </td>
                        <td class="dataComment text-center">
                            {% if service_order.fileComment1 %}
                                {{service_order.fileComment1 }}
                            {% endif %}

                        </td>
                    </tr>
                {% endif %}
                {% if stlFile %}
                    {% for i in stlFile %}
                    <tr class="imageDataApproval imageDataApproval3">
                        <td></td>
                        <td>
                            {% if i.fileStatus %}
                                {% if i.fileStatus == 'Approve'%}
                                    <span class="badge badge-success ml-2">Approved</span>
                                {% endif %}
                                {% if i.fileStatus == 'Reject'%}
                                    <span class="badge badge-warning ml-2">Rejected</span>
                                {% endif %}
                                {% if i.fileStatus == 'Re-uploaded'%}
                                    <span class="badge badge-info ml-2">Re-Uploaded</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {{i.fileName}} <span class="badge badge-primary ml-2">{{i.site}}</span> 
                        </td>
                        <td class="dataUpload d-flex justify-content-between align-items-center">
                            <a class="{{lineItem.down}}" download href="/downloadStlLab/{{service_order.id}}/{{lineItem.id}}/{{i.id}}">
                                <i class="fa-solid fa-download"></i>
                            </a>
                            <a class="{{lineItem.down}}" target="_blank" href="/downloadStlLab/{{service_order.id}}/{{lineItem.id}}/{{i.id}}">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                            {% if i.fileStatus != 'Approve' %}
                            <i class="fa-solid fa-file-lines" data-toggle="modal" data-target="#statusModal" onclick="onStatusModalClick('{{i.fileName}}', '{{i.id}}', 3)"></i>
                            {% endif %} 
                        </td>
                        <td class="dataComment text-center">
                            {% if i.fileComment %}
                                {{i.fileComment}}
                            {% endif %}
                        </td>               
                    </tr>
                    {% endfor%}
                {% endif %}
                <tr class="planSharedRow">
                    <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                    <th>Share Plan</th>
                    <td class="orderDetails">
                        {% if lineItem.status == 'Share Plan' %}
                            <span style="font-weight: 500;">{{lab_id}} </span>has shared the Planning File on <span style="font-weight: 500;">{{lineItem.GuideUploadDate}}</span> Kindly wait for the approval/rejection by the clinic.
                        {% endif %}
                        {% if lineItem.status == 'Review Plan' or  lineItem.status == 'Production Complete'  or lineItem.status == 'Order Completed' or lineItem.status == 'Share Design' or lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered' %}
                            <span style="font-weight: 500;">{{lab_id}} </span>has shared the Planning File on <span>{{lineItem.GuideUploadDate}}</span>
                        {% endif %}
                        {% if lineItem.status == 'Validate Data' and lineItem.GuideUpload != 'Uploaded' %}
                            <span style="font-weight: 500;">{{lab_id}} </span>is yet to upload the Plan. Kindly upload the <span style="font-weight: 500;"> Planning File</span> . 
                        {% endif %}
                    </td>    
                    <td>      
                        {% if lineItem.status == 'Validate Data' and lineItem.GuideUpload != 'Uploaded' %}
                            <i class="fa-solid fa-upload" style="float: left;" data-toggle="modal" onclick="getFiles()" data-target="#planShareModal"></i>            
                        {% endif %}

                        {% if lineItem.GuideUpload == 'Uploaded' %}
                            {% for i in feedFile%}
                            <a target="_blank" style="float: right;"  href="/downloadGuidePdf/{{service_order.id}}/{{lineItem.id}}/{{i.id}}">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                            <a href="" target="_blank" rel="noopener noreferrer" class="ml-2"><i class="fa fa-eye"></i></a>
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td></td>
                </tr>
                <tr class="planReviewedRow">
                    <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                    <th>Review Plan</th>
                    <td class="orderDetails">
                        {% if lineItem.status == 'Share Plan' %}
                            Please wait for the Clinic's response.
                        {% endif %}
                        {% if lineItem.status == 'Review Plan' or lineItem.status == 'Production Complete'  or lineItem.status == 'Order Completed' or lineItem.status == 'Share Design' or lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered' %}
                        <span style="font-weight: 500;">{{lineItem.name}}</span>  from <span style="font-weight: 500;">{{refer_id}}</span> has
                         {% for i in feedFile %}
                            {% if i.fileStatus == 'Reject' %}
                            <span style="font-weight: 500;">Rejected</span>
                            the plan at <span style="font-weight: 500;">{{i.date}} </span>  Please <span style="font-weight: 500;">Re-share</span> the Plan. 
                            {% endif %}
                            {% if i.fileStatus == 'Approve' %}
                            <span style="font-weight: 500;">Approved</span>
                            the plan at <span style="font-weight: 500;">{{i.date}} </span>  Please share the <span style="font-weight: 500;">Design</span>. 
                            {% endif %}
                            
                         {% endfor %}
                        {% endif %}
                    </td> 
                    <td></td>
                    <td></td>
                </tr>
                {% if feedFile %}
                <tr class="planApproval">
                    <td></td>
                    <th></th>
                    <td>
                        {% for i in feedFile %}
                            {% if i.fileStatus %}
                                {{i.fileName}}
                            {% endif %}
                            {% if i.fileStatus == 'Approve' %}
                                <span class="badge badge-success ml-2">Approved</span>
                            {% endif %}
                            {% if i.fileStatus == 'Reject' %}
                                <span class="badge badge-warning ml-2">Rejected</span>
                            {% endif %}
                            {% if i.fileStatus == 'Re-uploaded' %}
                                <span class="badge badge-warning ml-2">Re-uploaded</span>
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        {% for i in feedFile %}
                            {% if i.fileStatus == 'Reject' %}
                                <i class="fa-solid fa-upload" style="float: left;" data-toggle="modal" onclick="getFiles()" data-target="#planShareModal"></i>
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td class="dataComment text-center">
                        {% for i in feedFile%}
                        {% if i.fileComment %}
                        {{i.fileComment}}
                        {% endif %}
                        {% endfor %}
                    </td>
                </tr>
                {% endif %}
                <tr class="designSharedRow">
                    <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                    <th>Share Design</th>
                    <td class="orderDetails">
                        {% if lineItem.status == 'Share Design' or lineItem.status == 'Production Complete'  or lineItem.status == 'Order Completed'  or lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered' %}
                        <span style="font-weight: 500;">{{org.orgname}}</span>  has shared the Design on <span style="font-weight: 500;">{{lineItem.designUploadDate}}</span> 
                        {% endif %}
                        {% if lineItem.status == 'Review Plan' %}
                            {% for i in feedFile %}
                                {% if i.fileStatus == 'Approve' %}
                                <span style="font-weight: 500;">{{org.orgname}}</span> is yet to share the Design with <span style="font-weight: 500;">{{refer_id}}</span>. Kindly Upload the Design File.
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </td> 
                    <td>
                        {% if lineItem.status == 'Share Design' or  lineItem.status == 'Production Complete'  or lineItem.status == 'Order Completed'  or lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered' %}
                            {% for i in designFile %}
                            <a target="_blank" href="/downloaGuideDesign/{{service_order.id}}/{{lineItem.id}}/{{i.id}}"> <i class="fa-solid fa-download"></i> </a>
                            <a href="" target="_blank" rel="noopener noreferrer" class="ml-2"><i class="fa fa-eye"></i></a>
                            {% endfor %}
                        {% endif %}


                        {% if lineItem.status == 'Review Plan' %}
                            {% for i in feedFile %}
                                {% if i.fileStatus == 'Approve' %}
                                    <i class="fa-solid fa-upload" style="float: left;" data-toggle="modal" onclick="getFilesDesign()" data-target="#designShareModal"></i>
                      
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td></td>
                </tr>
                
                {% if lineItem.output_type == 'Plan + Design (.stl) + Fabrication' %}  
                <tr class="productionCompleted">
                    <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                    <th>Production Complete</th>
                    <td class="orderDetails">
                        {% if lineItem.status == 'Production Complete' or lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered' or lineItem.status == 'Order Completed' %}
                            Fabrication has been <span style="font-weight: 500;">Completed.</span>
                        {% endif %}
                        {% if lineItem.status == 'Share Design' %}
                            {% for i in feedFile%}
                                {% if i.fileStatus == 'Approve' %}
                                    Fabrication is yet to be <span style="font-weight: 500;">Completed.</span>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if lineItem.status == 'Share Design' %}
                            {% for i in feedFile%}
                                {% if i.fileStatus == 'Approve' %}
                                    <i class="fa fa-solid fa-file-lines" data-toggle="modal" data-target="#FabricationCompleteModal"></i>       
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td></td>
                </tr>
                <tr class="orderDispatchedRow">
                    <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                    <th>Order Dispatched</th>
                    <td class="orderDetails">
                        {% if lineItem.status == 'Production Complete' %}
                        {{org.orgname}} is yet to dispatch the <span style="font-weight: 500;"> Design.</span>
                        {% endif %}

                        {% if lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered' or lineItem.status == 'Order Completed' %}
                        <span style="font-weight: 500;">{{org.orgname}}</span>  has dispatched the Order at <span style="font-weight: 500;">{{lineItem.DispatchDate}}</span>, via <span style="font-weight: 500;">{{lineItem.shipby}}</span> courier vide tracking ID: <span style="font-weight: 500;">{{lineItem.trackingId}}</span>, to <span style="font-weight: 500;">{{lineItem.DispatchAddress}}</span>.</td> 
                        {% endif %}
                    <td>
                        {% if lineItem.status == 'Production Complete' %}
                        <i class="fa fa-solid fa-file-lines" data-toggle="modal" data-target="#dispatchModal"></i>
                        {% endif %}
                    </td>
                    <td></td>
                </tr>
                <tr class="orderDeliveredRow">
                    <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                    <th>Order Delivered</th>
                    <td class="orderDetails">
                        {% if lineItem.status == 'Order Dispatched' %}
                            Please make sure the Order is Delivered.
                        {% endif %}
                        {% if lineItem.status == 'Order Delivered' or lineItem.status == 'Order Completed' %}  
                            Order was delivered to <span style="font-weight: 500;">{{refer_id}}</span> , <span style="font-weight: 500;">{{lineItem.DispatchAddress}}</span>  at  <span style="font-weight: 500;">{{lineItem.orderDeliverDate}}</span> </td> 
                        {% endif %}
                    <td>
                        {% if lineItem.status == 'Order Dispatched' %}

                        <i class="fa fa-file-lines" data-toggle="modal" data-target="#deliveryModal"></i>
                        {% endif %}
                    </td>
                    <td></td>
                </tr>
                {% endif %}
                <tr class="orderCompleted">
                    <td><i class="fa fa-thin fa-circle timeLineCircle last"></i></td>
                    <th>Order Completed</th>
                    <td class="orderDetails">
                        {% if lineItem.status == 'Order Completed' %}
                        The order has been <span style="font-weight: 500;"> Completed.</span>
                        {% endif %}
                    </td>
                    <td></td>
                    <td></td>
                </tr>
               
            </tbody>
            
        </table>
        <div>

        </div>
    </div>

    <a href="#" onclick="window.location.reload(true);" class="position-absolute refresh-icon" >
        Refresh
        <i class="fa-solid fa-arrows-rotate"></i>
    </a>
   
</div>



<div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Review Image {imageName}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    <form action="/" method="post">
                        {% csrf_token %}
                        <div class="form-group form-inline row">
                            <label for="selectBox" class="col-sm-4">Approval Status:</label>
                            <select id="selectBox" name="selectBox" class="col-sm-6" onchange="onSelectChange(this)">
                                <!-- <option value="">select</option> -->
                                <option value="Approve">Approve</option>
                                <option value="Reject">Reject</option>
                            </select>
                        </div>
                        <div class="form-group form-inline row">
                            <label for="comment" class="col-sm-4">Comment:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <textarea name="comment" id="comment" class="col-sm-6" rows="5"></textarea>
                        </div>
                        <div class="form-group form-inline row justify-content-center mt-2">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Submit
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="planShareModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Upload Plan</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    {% if lineItem.status == 'Review Plan' %}
                    {% for i in feedFile %}
                    <form action='/addfilesGuideAgain/{{service_order.id}}/{{lineItem.id}}/{{i.id}}' method="post" class="dropzone dz" id="recommendationDiv">
                        {% endfor %}
                        {% endif %}
                    {% if lineItem.status == 'Validate Data' %}
                    <form action='/addfilesGuide/{{service_order.id}}/{{lineItem.id}}' method="post" class="dropzone dz" id="recommendationDiv">
                        {% endif %}
                        {% csrf_token %}
                        <div class="fallback">
                            <input name="file" id="file1" type="file" multiple/>
                        </div>
                    </form>
                </div>
                <div class="m-3">
                    <h6>Uploaded Files are:</h6>
                    <div id="fileNameBody">
                        
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
    <script>
        Dropzone.options.recommendationDiv = {
        acceptedFiles: ".pdf, .stl, .html",
        maxFiles:3,
        init: function() {
            this.hiddenFileInput.removeAttribute('multiple');
            this.on("processing", function(file) {
            });
            this.on("uploadprogress", function(file, progress) {
            });
            this.on("complete", function(file) {
                location.reload()
            });
            this.on("success", function(file){
                if (file.previewElement) {
                    getFiles();
                    return file.previewElement.classList.add("dz-success");
                }
            });
            this.on('resetFiles', function() {
                if(this.files.length != 0){
                    for(i=0; i<this.files.length; i++){
                        this.files[i].previewElement.remove();
                    }
                    this.files.length = 0;
                }
            });
            // this.hiddenFileInput.removeAttribute('multiple');
        }
    };
    
    </script>
</div>

<div class="modal fade" id="designShareModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Upload Plan</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    
                    {% if lineItem.status == 'Review Plan'  %}
                    <form action='/uploadGuideDesign/{{service_order.id}}/{{lineItem.id}}' method="post" class="dropzone dz" id="designShareDiv">
                        {% endif %}
                        {% csrf_token %}
                        <div class="fallback">
                            <input name="file" id="file1" type="file" multiple/>
                        </div>
                    </form>
                </div>
                <div class="m-3">
                    <h6>Uploaded Files are:</h6>
                    <div id="designFileBody">
                        
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
    <script>
        Dropzone.options.designShareDiv = {
        acceptedFiles: ".pdf, .stl",
        maxFiles:1,
        init: function() {
            this.hiddenFileInput.removeAttribute('multiple');
            this.on("processing", function(file) {
                // this.options.url = getUrl('form1');
            });
            this.on("uploadprogress", function(file, progress) {
            console.log("File progress", progress);
            });
            this.on("complete", function(file) {
                location.reload()
            });
            this.on("success", function(file){
                if (file.previewElement) {
                    getFilesDesign();
                    return file.previewElement.classList.add("dz-success");
                }
            });
            this.on('resetFiles', function() {
                if(this.files.length != 0){
                    for(i=0; i<this.files.length; i++){
                        this.files[i].previewElement.remove();
                    }
                    this.files.length = 0;
                }
            });
            // this.hiddenFileInput.removeAttribute('multiple');
        }
    };
    
    </script>
</div>

<div class="modal fade" id="dispatchModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Dispatch Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    <form action="/orderDispatch/{{service_order.id}}/{{lineItem.id}}" method="post">
                        {% csrf_token %}
                        <div class="form-group form-inline row">
                            <label for="courier" class="col-sm-4">Shipped By:</label>
                            <input type="text" placeholder="Enter courier name" name="courier" class="col-sm-6">
                        </div>
                        <div class="form-group form-inline row">
                            <label for="trackingId" class="col-sm-4">Tracking ID:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <input name="trackingId" placeholder="Enter tracking ID" id="trackingId" class="col-sm-6">
                        </div>
                        <div class="form-group form-inline row">
                            <label for="date" class="col-sm-4">Date:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <input type="date" name="date"class="col-sm-6" id="date">
                        </div>
                        <div class="form-group form-inline row">
                            <label for="address" class="col-sm-4">Shipped To:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <input type="address" name="address" placeholder="Enter delivery address" class="col-sm-6" id="address">
                        </div>
                        <div class="form-group form-inline row">
                            <label for="comment" class="col-sm-4">Comment:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <textarea name="comment" id="comment" placeholder="Enter your comment" class="col-sm-6" rows="5"></textarea>
                        </div>
                        <div class="form-group form-inline row justify-content-center mt-2">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Submit
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="deliveryModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Delivery Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    <form action="/orderDeliver/{{service_order.id}}/{{lineItem.id}}" method="post">
                        {% csrf_token %}
                        
                        <div class="form-group form-inline row">
                            <label for="date" class="col-sm-4">Date:</label>
                            <input type="date" name="date" id="date" class="col-sm-6">
                        </div>
                        
                        <div class="form-group form-inline row">
                            <label for="comment" class="col-sm-4">Comment:</label>
                            <textarea name="comment" id="comment" placeholder="Enter your comment" class="col-sm-6" rows="5"></textarea>
                        </div>
                        <div class="form-group form-inline row justify-content-center mt-2">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Submit
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="FabricationCompleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Fabrication Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body ">
                <div class="container mt-3">
                    <form action="/fabricationCompleteSurgi/{{lineItem.id}}" method="post">
                        {% csrf_token %}
                        <div class="form-group form-inline row form-check">
                            <input id="Fabrication-complete" required class="col-sm-1 form-check-input" type="checkbox" value="True" name="fabricationComplete" >
                            <label for="Fabrication-complete" class="col-sm-4 ml-3">Fabrication Completed? </label>
                        </div>
                        <style>
                            .form input:checked+label:after { {
                                display: none !important;
                            }
                        </style>  
                        
                        <div class="form-group form-inline row justify-content-center ml-3 mt-2">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Submit
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

</div>

<style>
    @media screen and (max-width: 992px) {
        .table-wrapper > div{
            width: 28px !important;
        }
    }
    
    .table thead tr th{
        border-bottom: none;
        color: blue;
    }
    .table{
        table-layout: auto; 
        min-width: 100%; 
        border-collapse: separate;
        border-spacing: 0 10px;
    }

    .table tbody tr:not(.dataApproval, .planApproval, .imageDataApproval) td, 
    .table tbody tr:not(.dataApproval, .planApproval, .imageDataApproval) th{
        border: 1px solid #e8e8f7;
        border-right: none;
    }
    
    .table tbody td:not(:first-child), .table tbody th:not(:first-child){
        border-left: none !important;
    }

    .table tbody tr td:last-child{
        border-right: 1px solid #e8e8f7;
    }

    .table tbody tr th{
        white-space: nowrap;
    }

    /* display to be none  */
    /* .orderDetails{
        display: none;
    } */

    /* .main-footer.text-center{
        margin-top: 1rem;
    } */

    #tableBody i:not(.timeLineCircle){
        color: grey;
        cursor: pointer;
    }

    #tableBody i:not(.timeLineCircle):hover{
        color: blue;
    }

    .timeLineCircle{
        color: rgb(156, 156, 156);
    }

    /* display to be none  */
    /* .planSharedRow i:not(.timeLineCircle){
        display: none;
    } */

     .dataApproval, .designApproval{
        display: none;
    }

    /* .main-footer{
        margin-top: 1rem !important;
    } */
    
    .table-wrapper{
        position: relative;
    }

    .table-wrapper > div{
        position: absolute;
        width: 23px;
        top: 7rem;
        bottom: 4.4rem;
        height: -webkit-fill-available;
        border-right: 1px dashed rgb(156, 156, 156);
    }

    .timeLineCircleIncomplete{
        animation: lastTimeLineCircleAnimation 2s infinite
    }

    @keyframes lastTimeLineCircleAnimation {
        0%{
            color: red;
        }
        50%{
            color: rgb(156, 156, 156);
        }
        100%{
            color: red;
        }
    }
    .refresh-icon{
        top: 15px;
        right: 0;
        padding: 8px 16px;
        background: #1f3f7f;
        border-radius: 5px;
        color: white;
    }
    .refresh-icon i{
        margin-left: 4px;
    }
</style>

<script>

{% if lineItem.status != 'Order Completed' %}
    document.querySelector('.last').classList.add('timeLineCircleIncomplete');
    // console.log(document.querySelector('.last'))
{% endif %}

function getFilesDesign(){
    console.log('inside getFilesDesign')
    let pk ='{{service_order.id}}';
    let id1 = '{{lineItem.id}}';
    let csr = $("input[name=csrfmiddlewaretoken]").val();    
    mydata={'pk': pk,'id1': id1, 'csrfmiddlewaretoken': csr};
    let f= document.getElementById('designFileBody');
    while (f.hasChildNodes()) {
      f.removeChild(f.firstChild);
    }

    $.ajax(
      {
        url: `/viewGuideDesignAPI/${pk}/${id1}`,
        method:'GET',
        data: mydata,

        success: function (data) {
            console.log('the sata is', data)
          if(data.length>0){
            // console.log("the data is", data[0]['id'])
        
            var main_id= data[0]['id'];
            $( data ).each(function(i) {
              var fileName1 = data[i]['fileName'].match(/[ \w-]+\.[\w-]*$/)[0];
              var table_row= document.createElement('tr');
              var table_heading= document.createElement('td');
              var table_heading2= document.createElement('td');
              table_heading.innerText= fileName1;
            //   table_heading2.appendChild(anchor);
              table_row.appendChild(table_heading);
              table_row.appendChild(table_heading2);
              f.appendChild(table_row);
            }); 
          }
        }
    });
  }
  

function getFiles(){
    console.log('inside getFiles')
    let pk ='{{service_order.id}}';
    let id1 = '{{lineItem.id}}';
    let csr = $("input[name=csrfmiddlewaretoken]").val();    
    mydata={'pk': pk,'id1': id1, 'csrfmiddlewaretoken': csr};
    let f= document.getElementById('fileNameBody');
    while (f.hasChildNodes()) {
      f.removeChild(f.firstChild);
    }

    $.ajax(
      {
        url: `/ViewGuidePDF/${pk}/${id1}`,
        method:'GET',
        data: mydata,

        success: function (data) {
            console.log('the sata is', data)
          if(data.length>0){
            // console.log("the data is", data[0]['id'])
        
            var main_id= data[0]['id'];
            $( data ).each(function(i) {
              var fileName1 = data[i]['file'].match(/[ \w-]+\.[\w-]*$/)[0];
              var table_row= document.createElement('tr');
              var table_heading= document.createElement('td');
              var table_heading2= document.createElement('td');

      
              table_heading.innerText= fileName1;
            //   table_heading2.appendChild(anchor);
              table_row.appendChild(table_heading);
              table_row.appendChild(table_heading2);
              f.appendChild(table_row);
            }); 
          }
        }
    });
  }
  
    function onSelectChange(target){
        if(target.value=='Reject'){
            document.getElementById('comment').required= 'required'
        }
    }
  
    // function ends 
    

    // color code ends here 

    function onStatusModalClick(name, id, number){
        document.querySelector('#statusModal h5').innerText=`Review Image: ${name}`
        let target= document.querySelector('#statusModal form');
        console.log('myRegFile', number);
        if(number == 1){
            target.action ='/updateFileStatusFirst/{{service_order.id}}/{{lineItem.id}}';
        }
        else if(number == 2){
            target.action ='/updateFileStatusSecond/{{service_order.id}}/{{lineItem.id}}';
            console.log(target.action);
        }
        else{
            target.action=`/iosFileStatusGuide/${id}/{{lineItem.id}}`;
        }
    };

    if('{{lineItem.data_type2}}'==	'Denture Only CBCT' && document.querySelector('.dataUpload:nth-child(2) a')){
        document.querySelector('.dataUpload:nth-child(2) a').href=''
    }

    // code to display the timeline based on the output_type

    if('{{lineItem.output_type}}'=='Prosthetically Driven Planning'){
       document.querySelector('.designSharedRow').style.display='none';  
       document.querySelector('.orderDispatchedRow').style.display='none';  
       document.querySelector('.orderDeliveredRow').style.display='none';  

    }
    else if('{{lineItem.output_type}}'=='Plan + Design (.stl)'){
        document.querySelector('.orderDispatchedRow').style.display='none';  
        document.querySelector('.orderDeliveredRow').style.display='none';  
    }

    // code  ends here 

    // code to hide the details from every other timeline event 


    
    if('{{lineItem.status}}'=='Submit Order'){
        for (let x of document.querySelectorAll('.imageDataApproval')){
            x.style.display='table-row';
        }
    }
    if('{{lineItem.status}}'!='Submit Order' && '{{lineItem.status}}'!='Validate Data' && '{{lineItem.status}}'!='Share Plan'){
        document.querySelector('.planApproval').style.display='table-row';
    }


    if('{{lineItem.status}}'!='Submit Order' && '{{lineItem.status}}'!='Validate Data'){
        document.querySelector('.planSharedRow i').style.display='inline';
    }
    
</script>
<script>
    {% for i in feedFile %}

    if( '{{i.fileStatus}}'=='Reject'){
        document.querySelector('.planApproval').style.background='#ffcdcd'
    }
    else if( '{{i.fileStatus}}'=='Approve'){
        document.querySelector('.planApproval').style.background='#c1ffc1'
    }

{% endfor %}
</script>
<script>
    // to provide colors to the circles

    for(let x of document.querySelectorAll('#tableBody tr th')){
        if(x.previousElementSibling && x.previousElementSibling.querySelector('i')){
            x.previousElementSibling.querySelector('i').style.color='green';
        }
        if(x.innerText =='{{lineItem.status}}'){
            break;
        }
    }
</script>

{% endif %}
{% endblock %}