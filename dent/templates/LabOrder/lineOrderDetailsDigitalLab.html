{% extends 'dentread_dashbase.html' %}
{% load static %}
{% block content %}
{% if user.is_authenticated %}

<div class="container  position-relative" id="mainContainer" style=" padding: 2rem 3rem 0 3rem;">
    
    <div class="table-wrapper" style="padding: 1rem; background-color: white;">
        <table class="table" >
            <thead id="tableHead">
                <tr style="color: blue; text-align: center;">
                    <th></th>
                    <th>Status</th>
                    <th style="width: 45%;">Details</th>
                    <th style="width: 15%;">Action</th>
                    <th style="width: 30%;">Comments</th>
                </tr>
            </thead>

            <tbody id="tableBody">
                     
                <tr class="orderSubmittedRow">
                    <td><i class="fa fa-duotone fa-circle timeLineCircle"></i></td>
                    <th>Submit Order</th>
                    <td class="orderDetails"><span style="font-weight: 500;">{{lineItem.name}}</span>  from <span style="font-weight: 500;">{{refer_id}}</span>  submitted a Service Order for <span style="font-weight: 500;">Digital Lab Services</span> at <span style="font-weight: 500;">{{lineItem.date}}</span> </td>   
                    <td></td>
                    <td></td>
                </tr>
                {% if service_order.preferredData == 'nonDigitalData' %}
                    <tr class="orderPickedUpRow">
                        <td><i class="fa fa-duotone fa-circle timeLineCircle"></i></td>
                        <th>Pickup Order</th>
                        <td class="orderDetails">
                            {% if lineItem.orderPickup == False and lineItem.availableForCollection == True %}
                                Order is yet to be picked up by the dental lab <span style="font-weight: 500;"> {{ org.orgname}}</span> 
                            {% endif %}
                            {% if lineItem.orderPickup == True %}
                                Order has been picked up by the dental lab <span style="font-weight: 500;"> {{ org.orgname}}</span>
                                on  <span style="font-weight: 500;"> {{ lineItem.orderPickupTime }}</span>
                            {% endif %}
                        </td>   
                        <td class="text-center">
                            {% if lineItem.orderPickup == False and lineItem.availableForCollection == True %}
                            <i class="fa-solid fa-file-lines" data-toggle="modal" data-target="#orderPickUpModal" ></i> 
                            {% endif %}
                        </td>
                        <td></td>
                    </tr>
                {% endif %}
                
                <tr class="dataValidatedRow">
                    <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                    <th>Validate Data</th>
                    <td class="orderDetails"> 
                        {% if service_order.preferredData == 'digitalData' %}
                            {% if lineItem.status == 'Submit Order' %}
                                Lab <span style="font-weight: 500;">{{org.orgname}}</span> is yet to review the shared data
                            {% endif %}
                            {% if lineItem.status != 'Submit Order' %}
                                <span style="font-weight: 500;">{{org.orgname}}</span>  has reviewed the shared data
                            {% endif %}
                        {% endif %}

                        {% if service_order.preferredData == 'nonDigitalData' %}
                            {% if lineItem.status == 'Pickup Order' %}
                                Data Review Pending by <span style="font-weight: 500;">{{org.orgname}}</span>
                            {% endif %}
                            {% if lineItem.status != 'Submit Order' and  lineItem.status != 'Pickup Order' %}
                                <span style="font-weight: 500;">{{org.orgname}}</span>  has reviewed the shared data
                            {% endif %}
                        {% endif %}
                    </td>
                    
                    <td class="text-center">
                        {% if lineItem.status == 'Pickup Order' %}
                            <i class="fa-solid fa-file-lines" data-toggle="modal" data-target="#statusModal" onclick="onStatusModalClick('{{lineItem.id}}', '', 'nonDigitalData')"></i> 
                        {% endif %}
                    </td>
                    
                    <td></td>
                    
                    <!-- <table>
                    </table> -->
                </tr>
                {% for i in stlFile %}
                <tr class="imageDataApproval imageDataApproval2">
                    <td></td>
                    <th>
                        <span class="badge badge-light">{{ i.site }}</span>

                    </th>
                    <td>
                        {{ i.fileName }}
                        {% if i.fileStatus %}
                        {% autoescape off %}
                            {{i.badge}}
                        {% endautoescape %}
                        {% endif %}                            
                    </td>

                    <td class="dataUpload d-flex justify-content-between align-items-center">
                        <a class="{{lineItem.down}}" download  href="/downloadStlDigitalLab/{{service_order.id}}/{{lineItem.id}}/{{i.id}}">
                            <i class="fa-solid fa-download"></i>
                        </a>
                        <a class="{{lineItem.down}}" target="_blank"  href="/viewStl/{{service_order.id}}/{{lineItem.id}}/{{i.id}}/{{i.site}}/{{i.fileName}}">
                            <i class="fa-solid fa-eye"></i>
                        </a>
                        {%  if i.fileStatus != 'Approve'  %}
                            <i class="fa-solid fa-file-lines" data-toggle="modal" data-target="#statusModal" onclick="onStatusModalClick('{{i.id}}', '{{i.fileName}}')"></i>
                        {% endif %}     
                    </td>
                    <td class="dataComment text-center">
                        {% if i.fileComment %}
                            {{i.fileComment}}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}

                {% if lineItem.status != 'Order Cancelled' and lineItem.status  != 'Order On-Hold' %}

                    {% if lineItem.designCheck %}
                
                    <tr class="planSharedRow">
                        <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                        <th>Share Design</th>
                        <td class="orderDetails">

                            {% if lineItem.status == 'Share Design' %}
                                {% if lineItem.designStatus == 'Reject' %}
                                    <span style="font-weight: 500;">{{lab_id}} </span>has shared the Design at <span>{{lineItem.GuideUploadDate}}</span>
                                {% endif %}
                                {% if lineItem.designStatus != 'Reject' %}
                                    <span style="font-weight: 500;">{{lab_id}} </span>has shared the Design at <span style="font-weight: 500;">{{lineItem.GuideUploadDate}}</span>. Kindly wait for the approval/rejection by the clinic.
                                {% endif %}

                            {% endif %}

                            {% if lineItem.status == 'Review Design' or lineItem.status == 'Production Complete' or lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered' %}
                                <span style="font-weight: 500;">{{lab_id}} </span>has shared the Design at <span>{{lineItem.GuideUploadDate}}</span>
                            {% endif %}

                            {% if lineItem.status == 'Validate Data' %}                         
                                {% if lineItem.fileStatus == 'Approved' or lineItem.dataApprove == 'Approve' %}
                                    <span style="font-weight: 500;">{{lab_id}} </span>is yet to upload the Design. Kindly Upload. 
                                {% endif %}

                            {% endif %}
                        </td>
                        <td class="text-center">
                            
                            {% if lineItem.status == 'Validate Data' %}
                                {% if lineItem.fileStatus == 'Approved' or lineItem.dataApprove == 'Approve' %}
                                    <i class="fa-solid fa-upload"  data-toggle="modal" onclick="getFiles()" data-target="#planShareModal"></i>    
                                {% endif %}
                            {% endif %}

                            
                            <!-- <i class="fa-solid fa-download mr-3"></i><i class="fa-solid fa-file-lines" data-toggle="modal" data-target="#statusModal"></i> -->
                        </td>

                        <td></td>
                    </tr>

                    <tr class="planReviewedRow">
                        <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                        <th>Review Design</th>
                        <td class="orderDetails">

                            {% if lineItem.status == 'Review Design' or lineItem.status == 'Production Complete' or lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered' %}

                                <span style="font-weight: 500;">{{lineItem.name}}</span>  from <span style="font-weight: 500;">{{refer_id}}</span> has
                                {{lineItem.designStatus}}ed the design.

                            {% endif %}

                            {% if lineItem.status == 'Share Design' %}
                                {% if lineItem.designStatus == 'Reject' %}
                                    <span style="font-weight: 500;">{{lineItem.name}}</span>  from <span style="font-weight: 500;">{{refer_id}}</span> has
                                    {{lineItem.designStatus}}ed the design.
                                {% endif %}
                                {% if lineItem.designStatus != 'Reject' %}
                                    <span style="font-weight: 500;">{{refer_id}} </span> is yet to review the design
                                {% endif %} 
                            {% endif %}
                        </td> 
                        <td class="text-center">
                            {% if lineItem.designStatus == 'Reject' %}
                                <i class="fa-solid fa-upload" style="float: left;" data-toggle="modal" onclick="getFiles()" data-target="#planShareModal"></i>
                            {% endif %}
                        </td>
                        <td></td>
                    </tr>
                    
                    <tr class="planApproval">
                        <td></td>
                        <th>
                            {% if lineItem.designStatus == 'Approve' %}
                            <span class='badge badge-success'>Approved</span>
                            {% endif %}
                            {% if lineItem.designStatus == 'Reject' %}
                            <span class='badge badge-danger'>Rejected</span>
                            {% endif %}
                            {% if lineItem.designStatus == 'Re-uploaded' %}
                            <span class='badge badge-warning'>Re-Uploaded</span>
                            {% endif %}
                        </th>
                        <td>
                            
                            {% for i in feedFile%}
                                {% if i.fileName %}
                                    <span> {{i.fileName}} </span>
                                    
                                {% endif %}
                                <br> 
                            {% endfor %}

                        </td>
                        <td class="text-center">
                            {% for i in feedFile%}
                                {% if i.fileName %}
                                    <a download href="/downloadLabPlanPdf/{{service_order.id}}/{{lineItem.id}}/{{i.id}}">
                                        <i class="fa-solid fa-download"></i>
                                    </a>
                                    {% if stlCheck == True %}
                                        <a href="/requestPlanningFile/{{service_order.id}}/{{lineItem.id}}" target="_blank" rel="noopener noreferrer" class="ml-2"><i class="fa-solid fa-eye"></i></a>
                                    {% else %}
                                        <a href="/downloadLabPlanPdf/{{service_order.id}}/{{lineItem.id}}/{{i.id}}" target="_blank" rel="noopener noreferrer" class="ml-2"><i class="fa-solid fa-eye"></i></a>
                                    {% endif %}
                                {% endif %}
                                <br> 
                            {% endfor %}
                       
                        </td>
                        <td class="dataComment text-center">
                            {% for i in feedFile%}
                                {% if i.fileComment %}
                                    {{i.fileComment}}
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}

                    <tr class="orderCompleted">
                        <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                        <th>Production Complete</th>
                        <td class="orderDetails">
                           
                            {% if lineItem.status == 'Production Complete' or lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered' %}
                                Fabrication has been completed
                            {% endif %}
                            {% if lineItem.status == 'Review Design'%}
                                Fabrication is yet to be completed.
                            {% endif %}
                            {% comment %} {% if lineItem.status == 'Validate Data' and lineItem.designCheck == None %}
                            Fabrication is yet to be completed
                            {% endif %} {% endcomment %}
                        </td>
                        <td class="text-center">
                           
                            {% if lineItem.status == 'Review Design' %}
                                <i class="fa fa-solid fa-file-lines" data-toggle="modal" data-target="#FabricationCompleteModal"></i>       
                            {% endif %}
                            {% if lineItem.status == 'Validate Data' and lineItem.designCheck == None and lineItem.fileStatus == 'Approved' %}
                                <i class="fa fa-solid fa-file-lines" data-toggle="modal" data-target="#FabricationCompleteModal"></i>           
                            {% endif %}

                        </td>
                        <td></td>
                    </tr>

                    <tr class="orderDispatchedRow">
                        <td><i class="fa fa-thin fa-circle timeLineCircle"></i></td>
                        <th>Order Dispatched</th>
                        <td class="orderDetails">

                            {% if lineItem.status == 'Production Complete' %}
                                
                                <span style="font-weight: 500;">{{org.orgname}}</span> is yet to dispatch the order.
                                   
                            {% endif %}

                            {% if lineItem.status == 'Order Dispatched' or lineItem.status == 'Order Delivered'%}
                                <span style="font-weight: 500;">{{org.orgname}}</span>  has dispatched the Order at <span style="font-weight: 500;">{{lineItem.DispatchDate}}</span>, via <span style="font-weight: 500;">{{lineItem.shipby}}</span> courier vide tracking ID: <span style="font-weight: 500;">{{lineItem.trackingId}}</span>, to <span style="font-weight: 500;">{{lineItem.DispatchAddress}}</span>.</td> 
                            {% endif %}
                        <td class="text-center">
                           
                            {% if lineItem.status == 'Production Complete' %} 
                                <i class="fa fa-solid fa-file-lines" data-toggle="modal" data-target="#dispatchModal"></i>
                            {% endif %}
                        </td>
                        <td></td>
                    </tr>

                    <tr class="orderDeliveredRow">
                        <td><i class="fa fa-thin fa-circle timeLineCircle last"></i></td>
                        <th>Order Delivered</th>
                        <td class="orderDetails">
                            {% if lineItem.status == 'Order Delivered'%}
                                Order was delivered to <span style="font-weight: 500;">{{refer_id}}</span> , <span style="font-weight: 500;">{{lineItem.DispatchAddress}}</span>  at  <span style="font-weight: 500;">{{lineItem.orderDeliverDate}}</span> 
                            {% endif %}
                            {% if lineItem.status == 'Order Dispatched' %}
                                <span style="font-weight: 500;">{{org.orgname}}</span> is yet to deliver the order.
                            {% endif %}
                        </td> 
                        <td class="text-center">
                            {% if lineItem.status == 'Order Dispatched' %}
                                <i class="fa fa-file-lines" data-toggle="modal" data-target="#deliveryModal"></i>
                            {% endif %}
                        </td>
                        <td></td>
                    </tr>

                {% endif %}

                {% if lineItem.status == 'Order Cancelled' %}

                    <tr class="orderCancelledRow">
                        <td><i class="fa fa-thin fa-circle timeLineCircle orderCancelledCircle"></i></td>
                        <th>Order Cancelled</th>

                        <td class="orderDetails">
                            
                            <span style="font-weight: 500;">{{usr.name}} </span> 
                            from 
                            <span style="font-weight: 500;">{{org.orgname}}</span>  
                            cancelled the order on 
                            <span style="font-weight: 500;">{{cancelled_time}}</span>
                            citing the reason 
                            <span style="font-weight: 500;">{{reason}}</span>    

                        </td>   
               
                        <td></td>
                        <td></td>
                    </tr>
                {% endif %}

                {% if lineItem.status == 'Order On-Hold' %}
                    <tr class="orderOnHoldRow">
                        <td><i class="fa fa-thin fa-circle timeLineCircle onHoldCircle"></i></td>
                        <th>Order On-Hold</th>

                        <td class="orderDetails">
                            
                            <span style="font-weight: 500;">{{usr.name}} </span> 
                            from 
                            <span style="font-weight: 500;">{{org.orgname}}</span>  
                            put the order on hold on
                            <span style="font-weight: 500;">{{cancelled_time}}</span>
                            citing the reason 
                            <span style="font-weight: 500;">{{reason}}</span>    

                        </td>   
               
                        <td></td>
                        <td></td>
                    </tr>
                {% endif %}
               
            </tbody>
            
        </table>
        <div class="path">
        </div>
    </div>

    <a href="#" onclick="window.location.reload(true);" class="position-absolute refresh-icon" >
        Refresh
        <i class="fa-solid fa-arrows-rotate"></i>
    </a>
</div>

<div class="modal fade" id="orderPickUpModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Order Pickup Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    <form action="/orderPickup/{{lineItem.id}}" method="post">
                        {% csrf_token %}
                        <div class="form-group form-inline row form-check">
                            <label for="orderPickUpCheck" class="col-sm-4">Order Picked-up? </label>
                            <input id="orderPickUpCheck" class="col-sm-1 ml-3 form-check-input" type="checkbox" value="True" name="orderPickup" required>
                        </div>
                        <div class="form-group form-inline row">
                            <label for="orderPickupTime" class="col-sm-4">Pickup Date:</label>
                            <input type="date" name="orderPickupTime" class="col-sm-6 offset-sm-1 order-pickup--date" id="orderPickupTime" required>
                        </div>
                        <div class="form-group form-inline row justify-content-center ml-3 mt-2">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Submit
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="FabricationCompleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Fabrication Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body ">
                <div class="container mt-3">
                    <form action="/fabricationComplete/{{lineItem.id}}" method="post">
                        {% csrf_token %}
                        <div class="form-group form-inline row form-check">
                            <input id="Fabrication-complete" required class="col-sm-1 form-check-input" type="checkbox" value="True" name="fabricationComplete" >
                            <label for="Fabrication-complete" class="col-sm-6">Fabrication Completed? </label>
                            <button type="submit" class="btn btn-sm btn-primary col-sm-3 ml-3">
                                Submit
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="statusModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Review Data</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    <form action="/" method="post">
                        {% csrf_token %}
                        <div class="form-group form-inline row">
                            <label for="selectBox" class="col-sm-4">Approval Status:</label>
                            <select id="selectBox" required name="selectBox" class="col-sm-6" onchange="onSelectChange(this)">
                                <!-- <option value="">select</option> -->
                                <option value="Approve">Approve</option>
                                <option value="Reject">Reject</option>
                            </select>
                        </div>
                        <div class="form-group form-inline row">
                            <label for="comment" class="col-sm-4">Comment:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <textarea name="comment" id="comment" class="col-sm-6" rows="5"></textarea>
                        </div>
                        <div class="form-group form-inline row justify-content-center mt-2">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Submit
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="planShareModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Upload Design</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    {% if lineItem.status == 'Review Design' or lineItem.status == 'Share Design' %}
                            <form action='/addfilesGuideDigitalAgain/{{service_order.id}}/{{lineItem.id}}' method="post" class="dropzone dz" id="recommendationDiv">
                    {% endif %}

                    {% if lineItem.status == 'Validate Data' %}
                        <form action='/addfilesGuideDigital/{{service_order.id}}/{{lineItem.id}}' method="post" class="dropzone dz" id="recommendationDiv">
                    {% endif %}
                        {% csrf_token %}
                        <div class="fallback">


                            <input name="file" id="file1" type="file" multiple/>
                        </div>
                    </form>
                </div>
                <div class="m-3">
                    <h6>Uploaded Files are:</h6>
                    <div id="fileNameBody">
                        
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
    <script>
        Dropzone.options.recommendationDiv = {
        acceptedFiles: ".pdf, .stl, .html",
        maxFiles:5,
        init: function() {
            this.hiddenFileInput.removeAttribute('multiple');
            this.on("processing", function(file) {
            });
            this.on("uploadprogress", function(file, progress) {
            console.log("File progress", progress);
            })
            this.on("success", function(file){
                if (file.previewElement) {
                    getFiles();
                    return file.previewElement.classList.add("dz-success");
                }
            });
            this.on('resetFiles', function() {
                if(this.files.length != 0){
                    for(i=0; i<this.files.length; i++){
                        this.files[i].previewElement.remove();
                    }
                    this.files.length = 0;
                }
            });
        }
    };
    
    </script>
</div>

<div class="modal fade" id="designShareModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Upload Plan</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    
                    {% if lineItem.status == 'Plan Review'  %}
                    <form action='/uploadGuideDesign/{{service_order.id}}/{{lineItem.id}}' method="post" class="dropzone dz" id="designShareDiv">
                        {% endif %}
                        {% csrf_token %}
                        <div class="fallback">
                            <input name="file" id="file1" type="file" multiple/>
                        </div>
                    </form>
                </div>
                <div class="m-3">
                    <h6>Uploaded Files are:</h6>
                    <div id="designFileBody">
                        
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
    <script>
        Dropzone.options.designShareDiv = {
        acceptedFiles: ".pdf, .stl",
        maxFiles:1,
        init: function() {
            this.hiddenFileInput.removeAttribute('multiple');
            this.on("processing", function(file) {
            });
            this.on("uploadprogress", function(file, progress) {
            console.log("File progress", progress);
            });
            this.on("success", function(file){
                if (file.previewElement) {
                    getFilesDesign();
                    return file.previewElement.classList.add("dz-success");
                }
            });
            
            this.on('resetFiles', function() {
                if(this.files.length != 0){
                    for(i=0; i<this.files.length; i++){
                        this.files[i].previewElement.remove();
                    }
                    this.files.length = 0;
                }
            });
        }
    };
    
    </script>
</div>

<div class="modal fade" id="dispatchModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Dispatch Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    <form action="/orderDispatchDigital/{{service_order.id}}/{{lineItem.id}}" method="post">
                        {% csrf_token %}
                        <div class="form-group form-inline row">
                            <label for="courier" class="col-sm-5">Shipped By:</label>
                            <input type="text" required placeholder="Enter courier name" name="courier" class="col-sm-6">
                        </div>
                        <div class="form-group form-inline row">
                            <label for="trackingId" class="col-sm-5">Tracking ID:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <input name="trackingId" required placeholder="Enter tracking ID" id="trackingId" class="col-sm-6">
                        </div>
                        <div class="form-group form-inline row">
                            <label for="date" class="col-sm-5">Expected Date:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <input type="date" required name="date" class="col-sm-6 expected-delivery--date" id="date">
                        </div>
                        <div class="form-group form-inline row">
                            <label for="address" class="col-sm-5">Shipped To:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <input type="address" required name="address" placeholder="Enter delivery address" class="col-sm-6" id="address">
                        </div>
                        <div class="form-group form-inline row">
                            <label for="comment" class="col-sm-5">Comment:</label>
                            <!-- <textarea type="text"  class="col-sm-6" rows="5"> -->
                            <textarea name="comment" id="comment" placeholder="Enter your comment" class="col-sm-6" rows="5"></textarea>
                        </div>
                        <div class="form-group form-inline row justify-content-center mt-2">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Submit
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="deliveryModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Delivery Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container mt-3">
                    <form action="/orderDeliverDigital/{{service_order.id}}/{{lineItem.id}}" method="post">
                        {% csrf_token %}
                        
                        <div class="form-group form-inline row">
                            <label for="date" class="col-sm-4">Date:</label>
                            <input type="date" required name="date" id="date" class="col-sm-6 order-delivered--date">
                        </div>
                        
                        <div class="form-group form-inline row">
                            <label for="comment" class="col-sm-4">Comment:</label>
                            <textarea name="comment" id="comment" placeholder="Enter your comment" class="col-sm-6" rows="5"></textarea>
                        </div>
                        <div class="form-group form-inline row justify-content-center mt-2">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Submit
                            </button>
                        </div>

                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button type="button" id="closeButton" style="background: #a3a3a326; border-color: #a3a3a326; color: black; font-weight: 500; margin: 10px 0; margin-right: 1rem; border-radius: 3px; border-width: thin;" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>

</div>

<style>
    @media screen and (max-width: 992px) {
        .table-wrapper > div{
            width: 28px !important;
        }
    }

    .form input:checked+label:before, form input:checked+label:before,
    .form input:checked+label:after, form input:checked+label:after{
        display: none;
    }

    .orderCancelledCircle{
        color: red !important;
    }

    

    .onHoldCircle{
        color: yellow !important;
    }

    .table thead tr th{
        border-bottom: none;
        color: blue;
    }
    .table{
        table-layout: auto; 
        min-width: 100%; 
        border-collapse: separate;
        border-spacing: 0 10px;
    }

    .table tbody tr:not(.dataApproval, .planApproval, .imageDataApproval) td, 
    .table tbody tr:not(.dataApproval, .planApproval, .imageDataApproval) th{
        border: 1px solid #e8e8f7;
        border-right: none;
    }
    
    .table tbody td:not(:first-child), .table tbody th:not(:first-child){
        border-left: none !important;
    }

    .table tbody tr td:last-child{
        border-right: 1px solid #e8e8f7;
    }

    .table tbody tr th{
        white-space: nowrap;
    }

    /* display to be none  */
    /* .orderDetails{
        display: none;
    } */


    #tableBody i:not(.timeLineCircle){
        color: grey;
        cursor: pointer;
    }

    #tableBody i:not(.timeLineCircle):hover{
        color: blue;
    }

    .timeLineCircle{
        color: rgb(156, 156, 156);
    }

    /* display to be none  */
    /* .planSharedRow i:not(.timeLineCircle){
        display: none;
    } */

     .dataApproval, .planApproval, .designApproval{
        display: none;
    }

    
    .table-wrapper{
        position: relative;
    }

    .table-wrapper > div{
        position: absolute;
        width: 23px;
        top: 7rem;
        bottom: 4.4rem;
        height: -webkit-fill-available;
        border-right: 1px dashed rgb(156, 156, 156);
    }
    #mainContainer{
        margin-bottom: 1rem;
    }

    .timeLineCircleIncomplete{
        animation: lastTimeLineCircleAnimation 2s infinite
    }

    @keyframes lastTimeLineCircleAnimation {
        0%{
            color: red;
        }
        50%{
            color: rgb(156, 156, 156);
        }
        100%{
            color: red;
        }
    }
    .refresh-icon{
        top: 15px;
        right: 0;
        padding: 8px 16px;
        background: #1f3f7f;
        border-radius: 5px;
        color: white;
    }
    .refresh-icon i{
        margin-left: 4px;
    }
</style>

<script>
    console.log('{{lineItem.status}}')
    if('{{lineItem.status}}' == "Order On-Hold" || '{{lineItem.status}}' == "Order Cancelled"){
        if('{{lineItem.prevStatus}}' == 'Submit Order'){
            document.querySelector('.orderPickedUpRow').style.display = 'none'
            document.querySelector('.dataValidatedRow').style.display = 'none'
        }
        else if('{{lineItem.prevStatus}}' == 'Pickup Order'){
            document.querySelector('.dataValidatedRow').style.display = 'none'
        }
    }
</script>

<script>

var today = new Date().toISOString().split('T')[0];
document.getElementsByClassName("order-pickup--date")[0].setAttribute('max', today);
document.getElementsByClassName("expected-delivery--date")[0].setAttribute('min', today);
document.getElementsByClassName("order-delivered--date")[0].setAttribute('max', today);

{% if lineItem.status != 'Order Delivered' %}
    document.querySelector('.last').classList.add('timeLineCircleIncomplete');
{% endif %}
{% if lineItem.status == 'Order Delivered' %}
    document.querySelector('.table-wrapper>div').style.bottom = '5.7rem';
{% endif %}

function getFilesDesign(){
    console.log('inside getFilesDesign')
    let pk ='{{service_order.id}}';
    let id1 = '{{lineItem.id}}';
    let csr = $("input[name=csrfmiddlewaretoken]").val();    
    mydata={'pk': pk,'id1': id1, 'csrfmiddlewaretoken': csr};
    let f= document.getElementById('designFileBody');
    while (f.hasChildNodes()) {
      f.removeChild(f.firstChild);
    }

    $.ajax(
      {
        url: `/viewGuideDesignAPI/${pk}/${id1}`,
        method:'GET',
        data: mydata,

        success: function (data) {
            console.log('the sata is', data)
          if(data.length>0){
            // console.log("the data is", data[0]['id'])
        
            var main_id= data[0]['id'];
            $( data ).each(function(i) {
              var fileName1 = data[i]['fileName'].match(/[ \w-]+\.[\w-]*$/)[0];
              var table_row= document.createElement('tr');
              var table_heading= document.createElement('td');
              var table_heading2= document.createElement('td');

              table_heading.innerText= fileName1;
            //   table_heading2.appendChild(anchor);
              table_row.appendChild(table_heading);
              table_row.appendChild(table_heading2);
              f.appendChild(table_row);
            }); 
          }
        }
    });
  }
  

function getFiles(){
    console.log('inside getFiles')
    let pk ='{{service_order.id}}';
    let id1 = '{{lineItem.id}}';
    let csr = $("input[name=csrfmiddlewaretoken]").val();    
    mydata={'pk': pk,'id1': id1, 'csrfmiddlewaretoken': csr};
    let f= document.getElementById('fileNameBody');
    while (f.hasChildNodes()) {
      f.removeChild(f.firstChild);
    }

    $.ajax(
      {
        url: `/ViewGuideLabPDF/${pk}/${id1}`,
        method:'GET',
        data: mydata,

        success: function (data) {
            console.log('the sata is', data)
          if(data.length>0){
            // console.log("the data is", data[0]['id'])
        
            var main_id= data[0]['id'];
            $( data ).each(function(i) {
              var fileName1 = data[i]['file'].match(/[ \w-]+\.[\w-]*$/)[0];
              var table_row= document.createElement('tr');
              var table_heading= document.createElement('td');
              var table_heading2= document.createElement('td');

              table_heading.innerText= fileName1;
            //   table_heading2.appendChild(anchor);
              table_row.appendChild(table_heading);
              table_row.appendChild(table_heading2);
              f.appendChild(table_row);
            }); 
          }
        }
    });
  }
  
    function onSelectChange(target){
        if(target.value=='Reject'){
            document.getElementById('comment').required= 'required'
        }
    }
    
    {% for i in feedFile %}

        if( '{{i.fileStatus}}'=='Reject'){
            
            document.querySelector('.planApproval').style.background='#ffcdcd'
        }
        else if( '{{i.fileStatus}}'=='Approve'){
            document.querySelector('.planApproval').style.background='#c1ffc1'
        }
    
    {% endfor %}

  
    console.log('{{lineItem.status}}')
    for(let x of document.querySelectorAll('#tableBody tr th')){
        if(x.previousElementSibling && x.previousElementSibling.querySelector('i')){
            x.previousElementSibling.querySelector('i').style.color='green';
        }
        if(x.innerText=='{{lineItem.status}}'){
            break;
        }
    }

    // color code ends here 

    function onStatusModalClick(id, name= '', type='Digital'){
        document.querySelector('#statusModal h5').innerText=`Review Image: ${name}`
        let target= document.querySelector('#statusModal form');
        
        if(type == 'Digital'){
            target.action=`/iosFileStatus/${id}/{{lineItem.id}}`;
        }
        else{
            target.action=`/dataApprove/${id}`;
        }
            
    }

    if('{{lineItem.data_type2}}'==	'Denture Only CBCT' && document.querySelector('.dataUpload:nth-child(2) a')){
        document.querySelector('.dataUpload:nth-child(2) a').href=''
    }

    // code to display the timeline based on the output_type

    if('{{lineItem.output_type}}'=='Prosthetically Driven Planning'){
       document.querySelector('.designSharedRow').style.display='none';  
       document.querySelector('.orderDispatchedRow').style.display='none';  
       document.querySelector('.orderDeliveredRow').style.display='none';  

    }
    else if('{{lineItem.output_type}}'=='Plan + Design (.stl)'){
        document.querySelector('.orderDispatchedRow').style.display='none';  
        document.querySelector('.orderDeliveredRow').style.display='none';  
    }

    // code  ends here 

    // code to hide the details from every other timeline event 


    
    if('{{lineItem.status}}'=='Submit Order'){
        for (let x of document.querySelectorAll('.imageDataApproval')){
            x.style.display='table-row';
        }
    }
    if('{{lineItem.status}}'!='Submit Order' && '{{lineItem.status}}'!='Data Validate' && '{{lineItem.status}}'!='Plan Share'){
        document.querySelector('.planApproval').style.display='table-row';
    }


    if('{{lineItem.status}}'!='Submit Order' && '{{lineItem.status}}'!='Data Validate'){
        document.querySelector('.planSharedRow i').style.display='inline';
    }
    
</script>

{% endif %}
{% endblock %}